name: premerge-notebooks

on:
  # quick tests of modified notebooks for every pull request
  push:
    branches:
      - main
  pull_request:

concurrency:
  # automatically cancel the previously triggered workflows when there's a newer version
  group: build-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: Set up Python 3.10
      uses: actions/setup-python@v3
      with:
        python-version: '3.10'
    - name: Install MONAI
      id: monai-install
      env:
        PIP_NO_CACHE_DIR: "1"
        PIP_DISABLE_PIP_VERSION_CHECK: "1"
      run: |
        find  /opt/hostedtoolcache/* -maxdepth 0 ! -name 'Python' -exec rm -rf {} \;
        df -h
        which python
        python -m pip install -U pip wheel
        # Force CPU-only PyTorch wheels so we don't download huge CUDA/nvidia-* wheels in CI.
        # Keep PyPI available for torch's dependencies.
        python -m pip install --index-url https://download.pytorch.org/whl/cpu --extra-index-url https://pypi.org/simple torch torchvision torchaudio

        python -m pip install -r https://raw.githubusercontent.com/Project-MONAI/MONAI/dev/requirements-dev.txt
        python -m pip install -r requirements.txt

        # Avoid PEP517 build isolation (which can re-install torch and pull CUDA wheels).
        BUILD_MONAI=0 python -m pip install --no-build-isolation git+https://github.com/Project-MONAI/MONAI#egg=MONAI
        python -m pip list
    - name: Notebook quick check
      shell: bash
      run: |
        python -c "import monai; monai.config.print_debug_info()"
        git fetch origin main
        git diff --name-only origin/main | while read line
        do
          if [[ $line == *.ipynb ]]
          then
            ./runner.sh -p " -and -wholename './${line}'"
          fi
        done
